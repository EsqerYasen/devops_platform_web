{% extends 'common/basic_layout.html' %}




{% block content %}


	<link href="/static/hplus/css/zTree/bootstrapStyle.css" rel="stylesheet">

<script type="text/javascript" src="/static/hplus/js/zTree/jquery.ztree.core.js"></script>
<script type="text/javascript" src="/static/hplus/js/zTree/jquery.ztree.excheck.js"></script>
<script type="text/javascript" src="/static/hplus/js/zTree/jquery.ztree.exedit.js"></script>


	{% include 'autotextheight.html' %}



	<style>
	.ztree li ul{
		padding: 0 0 0 10px;
	}
	.ibox-content{
		padding: 0px 0px 0px 0px;
	}
	</style>
<div class="wrapper wrapper-content fadeInRight" style="z-index: inherit">
    <div class="row addtoos">
        <div class="col-sm-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>Ansible管理</h5>
                </div>
                <div class="ibox-content">



	                <div class="treebox clear1">
			                <h4 class="clear">动态主机</h4>
			                <div class="row" >
				                 <div class="col-md-6" style="max-height: 400px;overflow:auto; border-right:1px solid #fefefe">
					                 <ul id="host_group_tree" name="host_group_tree" class="ztree" style="padding:0px"></ul>
				                 </div>
				                <div class="col-md-6">
					                <div  style="max-height: 360px;overflow:auto;padding-top:10px">

						                <table id="hostIpTb" class="table table-striped table-bordered table-hover dataTables-example dataTable">
					                      <thead>
					                        <tr>
					                            <th style="width:5%;"><input id="checkall" type="checkbox" class="i-checks"></th>
					                            <th>IP<span id="hostIpBadge" class="badge" style="margin-left: 20px;background-color: green;color: white">总：0台</span></th>
					                        </tr>
					                      </thead>
					                      <tbody></tbody>
					                  </table>

					                </div>


					                <div class="input-group" style="margin-top: 5px">
				                          <select id="host_go_live" class="form-control">
				                              <option value="2" selected>待上线主机</option>
				                              <option value="3">已上线主机</option>
				                          </select>
				                          <span class="input-group-btn">
				                              <button type="button" class="btn btn-primary" onclick="queryHostIp()">查询</button>
				                          </span>
				                      </div>

				                </div>


			                </div>




		                </div>
	                <div class="formbox_asb">

		                <form class="form-horizontal ">
						  <div class="form-group">
						    <label for="inputEmail3" class="col-sm-3 control-label">模块类型</label>
						    <div class="col-sm-9">
						      <input type="email" class="form-control" id="inputEmail3" placeholder="checkbox search">
						    </div>
						  </div>


						  <div class="form-group" style="border: 1px solid #eee;margin: 0px;padding: 5px 10px;margin-bottom: 15px;background: #fefefe;">
						    <label class="col-sm-12 control-label" style="padding-top: 0px;text-align: left;margin-bottom: 10px;text-align: left;padding: 0px;">模块参数</label>
						    <div class="col-sm-12" style="padding: 0px;">
							    <textarea class="form-control scriptarea" id="textarea" contenteditable="true"></textarea>
						    </div>
						  </div>

			               <div class="form-group">
						    <label for="inputPassword3" class="col-sm-3 control-label">详细结果</label>
						    <div class="col-sm-9">
						      <input type="text" class="form-control" id="inputPassword3" placeholder="select vvv">
						    </div>
						  </div>

			               <div class="form-group">
						    <label for="inputPassword3" class="col-sm-3 control-label">Debug</label>
						    <div class="col-sm-9">
						      <input type="text" class="form-control" id="inputPassword3" placeholder="debug">
						    </div>
						  </div>

						  <div class="form-group">
						    <div class="col-sm-offset-3 col-sm-9">
						      <button type="submit" class="btn btn-primary"> 执行 </button>
						    </div>
						  </div>
						</form>

	                </div>


	                <div class="logbox"></div>


	                <div style="clear: both; display: block; overflow: hidden"></div>





















                    
                </div>
            </div>
        </div>
    </div>
</div>





	<script>

	$(function(){
        var hostGroupTreeList = {{ hostGroup_list|safe }};
        readHostGroupTreeNext(hostGroupTreeList,0);
        zHostGroupTreeInit();
        {#initSelectHostModal();#}

    });




	var zHostGroupNodes = [];

    function readHostGroupTreeNext(list,pid){
        $(list).each(function(i,item){
            var ids = item.id;
            var nodeData = {id:ids,pId:pid,name:item.name,nodeId:ids,open:true,hasIp:item.has_ip};
            zHostGroupNodes.push(nodeData);
            if(item.childs){
                readHostGroupTreeNext(item.childs,ids);
            }
        });
    }

    function zHostGroupTreeInit(){
        var setting = {
            view: {
                selectedMulti: false,
            },
            check: {
                enable: true,
                chkboxType:  { "Y": "", "N": "" }
            },
            data: {
                simpleData: {
                    enable: true
                }
            },
            edit: {
                enable: false
            }
        };
        $.fn.zTree.init($("#host_group_tree"), setting, zHostGroupNodes);
    }

    function determineSelectHost(){
        var select_host_modal = $('#select_host_modal');
        var gid = select_host_modal.data('gid');
        //var selectHostValue = $("#selectHostValue"+gid);
        var ips = getCheckedHostIP();
        //selectHostValue.val('');

        var values = getSelectHostFromModal();

        if(!$.isEmptyObject(values)){
            var obj = {};
            obj = {'target_group_ids':values['id']}
            var target_type = 1;
            if(ips.length > 0){
                values['target_host_list']= ips;
                target_type = 3;
            }else{
                values['target_host_list']= "";
            }
            values['target_type'] = target_type;
            //obj['go_live'] = values['go_live'];
            //selectHostValue.val(JSON.stringify(obj));
            select_host_modal.modal('hide');
            store.commit('setHost', values);
        }else{
            Alertwin.alert({message:"请选择主机组或勾选机器"});
        }
    }

    function queryHostIp(){
        var values = getSelectHostFromModal();
        if(!$.isEmptyObject(values)){
            values['csrfmiddlewaretoken'] = '{{ csrf_token }}';
            values['limit'] = 100;
            $.ajax({
                type: "POST",
                url: '/platform/command_set/listByQueryCriteria/',
                data:values,
                error: function (request) {
                    layer.closeAll('loading');
                },
                success: function (data) {
                    createSelectHostIpTable(data.host_list.data);
                    layer.closeAll('loading');
                }
            });
        }else{
            Alertwin.alert({message:"选择机器功能异常"});
        }
    }

     function getSelectHostFromModal(){
        var result = {};
        var tabIds = $("#select_host_tab li[class='active'] a").attr('href');
        var host_group_tree=$.fn.zTree.getZTreeObj("host_group_tree");
        var nodes = host_group_tree.getCheckedNodes(true);
        var groupIds = "";
        $(nodes).each(function(i,item){
            groupIds += item.nodeId+",";
        });
        if(groupIds){
            groupIds = groupIds.substring(0,groupIds.length-1);
        }
        result['group_id'] = groupIds;

        if(!$.isEmptyObject(result)){
            result['go_live'] = $("#host_go_live").val();
        }
        return result;
    }


    function createSelectHostIpTable(data){
        var hostIpTb = $("#hostIpTb tbody");
        hostIpTb.empty();
        $("#hostIpBadge").text('总：0台');
        $("#checkall").unbind();

        if(data){
            $(data).each(function(i,item){

                var htmlStr =  htmlStr = "<tr>" +
                    "   <td>" +
                    "       <input type='checkbox' class='i-checks icheck' hostip='"+item+"' name='trCheckbox'>" +
                    "   </td>" +
                    "   <td>" + item +"</td>"+
                    "</tr>";
                hostIpTb.append(htmlStr);
            });
            $("#hostIpBadge").text('总：'+data.length+'台');
            $(".i-checks").iCheck({checkboxClass: "icheckbox_square-green", radioClass: "iradio_square-green",});
            $('#checkall').on('ifChecked', function (event) {
                $('.icheck').iCheck('check');
            });
            $('#checkall').on('ifUnchecked', function (event) {
                $('.icheck').iCheck('uncheck');
            });
        }
    }


    function getCheckedHostIP() {
        var str = document.getElementsByName("trCheckbox");
        var objarray = str.length;
        var idList = [];
        for (i = 0; i < objarray; i++) {
            if (str[i].checked == true) {
                idList.push($(str[i]).attr('hostip'));
            }
        }
        return idList;
    }

    var text = document.getElementById("textarea");
		autoTextarea(text,'',150);// 调用







	</script>
{% endblock %}