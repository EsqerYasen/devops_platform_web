{% extends 'common/basic_rank_list.html' %}
{% load widget_tweaks %}

{% block list_title %}
    未分配主机
{% endblock %}

{% block  group_count %}
    <div class="col-sm-8">
{#        {% if user.is_superuser %}#}
{#            <a href="../add/" class="btn btn-sm btn-info" style="margin-right: 10px">全部：300</a>#}
{#            <a href="../add/" class="btn btn-sm btn-info" style="margin-right: 10px">EC：100</a>#}
{#            <a href="../add/" class="btn btn-sm btn-info" style="margin-right: 10px">Brand：100</a>#}
{#            <a href="../add/" class="btn btn-sm btn-info" style="margin-right: 10px">Store：100</a>#}
{#        {% endif %}#}
    </div>
{% endblock %}

{% block  list_search %}
    <div class="col-sm-3" ></div>
    <div class="col-sm-2">
        <input type="text" name="host_ip" class="form-control" placeholder="请输入IP">
    </div>
{% endblock %}

{% block list_filter %}
    <button type="submit" class="btn btn-sm btn-primary" style="margin-right: 10px"><i class="fa fa-search"></i> 搜索</button>
    <button type="button" class="btn btn-sm btn-success" data-toggle='modal' data-target='#import_host_modal' style="margin-right: 10px"><i class="glyphicon glyphicon-import"></i> 导入</button>
    <button type="button" class="btn btn-sm btn-success" style="margin-right: 10px" onclick="toNotOnlineFun()"><i class="glyphicon glyphicon-log-in"></i> 待上线</button>
    <button type="button" class="btn btn-sm btn-success" onclick="scanBatch()" style="margin-right: 10px"><i class="glyphicon glyphicon-search"></i> 扫描</button>
{% endblock %}

{% block list_content %}
    <script type="text/javascript" src="/static/hplus/js/chosen/chosen.jquery.js"></script>
    <script type="text/javascript" src="/static/hplus/js/fileinput.min.js"></script>
    <script type="text/javascript" src="/static/hplus/js/fileinput.zh.js"></script>
    <script type="text/javascript" src="/static/hplus/js/zTree/jquery.ztree.core.js"></script>
    <script type="text/javascript" src="/static/hplus/js/zTree/jquery.ztree.excheck.js"></script>
    <script type="text/javascript" src="/static/hplus/js/zTree/jquery.ztree.exedit.js"></script>
    <link href="/static/hplus/css/chosen/chosen.css" rel="stylesheet">
    <link href="/static/hplus/css/fileinput.min.css" rel="stylesheet">
    <link href="/static/hplus/css/zTree/bootstrapStyle.css" rel="stylesheet">

    <div class="row">
        <div class="col-sm-3" style="max-height: 600px;overflow-y: auto">
            <ul id="host_group_tree" name="host_group_tree" class="ztree"></ul>
        </div>
        <div class="col-sm-9">
            <table id="tb" class="table table-striped table-bordered table-hover dataTables-example dataTable">
                <thead>
                    <tr>
                        <th style="width:3%;"><input id="checkall" type="checkbox" class="i-checks"></th>
                        <th style="width: 8%;">
                            机房
                        </th>
                        <th style="width: 8%;">
                            区域
                        </th>
                        <th style="width: 8%;">
                            IP
                        </th>
                        <th style="width: 11%;">
                            品牌
                        </th>
                        <th style="width: 6%;">
                            业务线
                        </th>
                        <th style="width:8%;">操作</th>
                    </tr>
                </thead>
                <tbody>
                {% for o in result_list %}
                    <tr>
                        <td>
                            <input type="checkbox" class="i-checks icheck" id="{{ o.id }}" hostip="{{ o.host_ip }}" name="trCheckbox">
                        </td>
                        <td>{{ o.physical_idc_name }}</td>
                        <td>{{ o.logical_idc_name }}</td>
                        <td>{{ o.host_ip }}</td>
                        <td>{{ o.biz_brand_name }}</td>
                        <td>{{ o.biz_group_name }}</td>
                        <td>
                            <a href="../{{ o.id }}/detail1/" class="btn btn-sm btn-success"><i class="fa fa-book"></i> 查看</a>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <script>
         $(document).ready(function () {
             var hostGroupTreeList = {{ hostGroup_list|safe }};
             readHostGroupTreeNext(hostGroupTreeList,0);
             zHostGroupTreeInit();
             importHostFile();
             initImportModal();
         })

         var zHostGroupNodes = [];
         function readHostGroupTreeNext(list,pid){
            $(list).each(function(i,item){
                var ids = item.id;
                var nodeData = {id:ids,pId:pid,name:item.name,nodeId:ids,open:true,hasIp:item.has_ip,'nocheck':true};

                if(item.childs){
                    readHostGroupTreeNext(item.childs,ids);
                }else{
                    nodeData['nocheck']=false;
                }
                zHostGroupNodes.push(nodeData);
            });
         }

         function zHostGroupTreeInit(){
            var setting = {
                view: {
                    selectedMulti: false,
                    addDiyDom: addDiyDom,
                },
                check: {
                    enable: true,
                    //chkboxType:  { "Y": "", "N": "" }
                },
                data: {
                    simpleData: {
                        enable: true
                    }
                },
                edit: {
                    enable: false
                },
                callback:{
                    onDblClick:zHostGroupTreeDblClick,
                }
            };
            $.fn.zTree.init($("#host_group_tree"), setting, zHostGroupNodes);
        }

        function addDiyDom(treeId, treeNode) {
             var aObj = $("#" + treeNode.tId + "_a");

             if(treeNode.hasIp == 1){
                 if($("#viewIpBtn_"+treeNode.id).length==0){
                     var viewBtn = "<span class='button ico_docu' id='viewIpBtn_" + treeNode.id+ "' title='节点下绑定的IP' onfocus='this.blur();'></span>";
                     aObj.append(viewBtn);
                     var btn = $("#viewIpBtn_"+treeNode.id);
                     if (btn){
                         btn.bind("click", function(){
                             alert("diy Button for " + treeNode.name + " "+treeNode.nodeId);
                             $("#viewIpBtn_"+treeNode.tId).unbind().remove();
                         });
                     }
                 }
             }
             if(!treeNode.nocheck){
                 if($("#bindIpToNode_"+treeNode.id).length==0){
                     var bindIpToNode = "<span class='button add' id='bindIpToNode_" + treeNode.id+ "' title='机器绑定' onfocus='this.blur();'></span>";
                     aObj.append(bindIpToNode);

                     var btn = $("#bindIpToNode_"+treeNode.id);
                     if (btn){
                         btn.bind("click", function(){
                             var ids = getChecked();
                             if (ids == "") {
                                 Alertwin.alert({ message: "请选择至少一条记录进行绑定"});
                             } else {
                                Alertwin.confirm({ message: "确定要绑定这批机器到 “"+treeNode.name+"”下吗？" }).on(function (e) {
                                    if(e){
                                        ids = ids.substring(0, ids.length - 1);
                                        bindingGroup(treeNode.id,ids);
                                    }
                                })

                             }
                             $("#bindIpToNode_"+treeNode.tId).unbind().remove();
                         });
                     }
                 }
                 if($("#removeIpFromNode_"+treeNode.id).length==0){
                     var removeIpFromNode = "<span class='button remove' id='removeIpFromNode_" + treeNode.id+ "' title='机器解绑' onfocus='this.blur();'></span>";
                     aObj.append(removeIpFromNode);
                     var btn = $("#removeIpFromNode_"+treeNode.id);
                     if (btn){
                         btn.bind("click", function(){
                             var ids = getChecked();
                             if (ids == "") {
                                 Alertwin.alert({ message: "请选择至少一条记录进行解绑"});
                             } else {
                                Alertwin.confirm({ message: "确定要解绑这批机器“"+treeNode.name+"”下吗？" }).on(function (e) {
                                    if(e){
                                        ids = ids.substring(0, ids.length - 1);
                                        unBindingGroup(treeNode.id,ids);
                                    }
                                })

                             }
                             $("#removeIpFromNode_"+treeNode.tId).unbind().remove();
                         });
                     }
                 }
             }
        }

        function zHostGroupTreeDblClick(event, treeId, treeNode){
            $(location).attr('href', '/cmdb/host/list1/?groupId='+treeNode.id);
        }

        function getCheckedHostIP() {
            var str = document.getElementsByName("trCheckbox");
            var objarray = str.length;
            var chestr = "";
            for (i = 0; i < objarray; i++) {
                if (str[i].checked == true) {
                    chestr += $(str[i]).attr('hostip') + ",";
                }
            }
            return chestr;
        }

        function scanBatch(){
            var obj = getCheckedHostIP();
            if (obj == "") {
                Alertwin.alert({ message: "请选择至少一条记录进行扫描"});
            } else {
                layer.load();
                obj = obj.substring(0, obj.length - 1);
                $.ajax({
                    type: "POST",
                    url: '../scanHost1/',
                    data:{'hostIp':obj,'csrfmiddlewaretoken':'{{ csrf_token }}'},
                    error: function (request) {
                        layer.closeAll('loading');
                    },
                    success: function (data) {
                        Alertwin.alert({ message: "扫描完成"});
                        layer.closeAll('loading');
                    }
                });
            }
        }

        function importHostFile(){
            $("#import_host_file").fileinput({
                showPreview: false,
                showUpload: false,
                elErrorContainer: '#kartik-file-errors',
                allowedFileExtensions: ['xls', 'xlsx'],
                maxFilesNum:1,
                language:'zh'
            });
        }

        function bindingGroup(groupId,ids){
            var host_ids = ids.split(',');
            var list = []
            $(host_ids).each(function(i,item){
                list.push(parseInt(item))
            })
            layer.load();
            $.ajax({
                type: "POST",
                url: '../host1BindingGroup/',
                data:{'group_id':groupId,"host_ids":JSON.stringify(list),'csrfmiddlewaretoken':'{{ csrf_token }}'},
                error: function (request) {
                    layer.closeAll('loading');
                },
                success: function (data) {
                    if(data.status==0){
                         Alertwin.alert({ message: "绑定成功"});
                    }else{
                        Alertwin.alert({ message: "绑定失败"});
                    }

                    layer.closeAll('loading');
                }
            });
        }

        function unBindingGroup(groupId,ids){
            var host_ids = ids.split(',');
            var list = []
            $(host_ids).each(function(i,item){
                list.push(parseInt(item))
            })
            layer.load();
            $.ajax({
                type: "POST",
                url: '../host1UnbundlingGroup/',
                data:{'group_id':groupId,"host_ids":JSON.stringify(list),'csrfmiddlewaretoken':'{{ csrf_token }}'},
                error: function (request) {
                    layer.closeAll('loading');
                },
                success: function (data) {
                    if(data.status==0){
                         Alertwin.alert({ message: "解绑成功"});
                    }else{
                        Alertwin.alert({ message: "绑解失败"});
                    }

                    layer.closeAll('loading');
                }
            });
        }

        function toNotOnlineFun(){
            var ips = getCheckedHostIP();
            if(ips){
                Alertwin.confirm({ message: "确定执行选中机器到待上线吗？" }).on(function (e) {
                    if(e){
                        layer.load();
                        $.ajax({
                            type: "POST",
                            url: '..//',
                            data:{'group_id':groupId,"host_ids":JSON.stringify(list),'csrfmiddlewaretoken':'{{ csrf_token }}'},
                            error: function (request) {
                                layer.closeAll('loading');
                            },
                            success: function (data) {
                                if(data.status==0){
                                     Alertwin.alert({ message: "解绑成功"});
                                }else{
                                    Alertwin.alert({ message: "绑解失败"});
                                }

                                layer.closeAll('loading');
                            }
                        });
                    }
                })
            }else{
                Alertwin.alert({ message: "请选择至少一条记录进行待上线操作"});
            }
        }

    </script>

{% endblock %}

{% block modal_div %}
    <div class="modal fade" id="import_host_modal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content" style="width: 600px">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">导入</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="max-height: 500px;overflow:auto">
                    <div class="col-sm-12">
                        <input id="import_host_file" type="file">
                    </div>
                    <div class="col-sm-5" style="margin-top: 20px;">
                        <a href="/cmdb/host/templateDownload/" class="link-popover" style="font-size: large">下载导入模板</a>
                    </div>
                    <div class="col-sm-5" style="margin-top: 20px;">
                        <button type="button" class="btn btn-sm btn-success" data-toggle='modal' data-target='#import_info_modal' style="margin-right: 10px"><i class="glyphicon glyphicon-search"></i> 查看后台任务</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" title="确定导入" onclick="importHostInfo()">确定</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="import_info_modal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true" >
        <div class="modal-dialog modal-lg" role="document" style="width: 800px">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">后台导入结果</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="max-height: 500px;overflow:auto">
                    <div class="row">
                        <div class="col-sm-3">
                            <label class="col-sm-1 control-label" style="width: 20px">总:</label><label id="import_info_total" class="col-sm-1 control-label" style="width: 150px"></label>
                        </div>
                        <div class="col-sm-3">
                            <label class="col-sm-1 control-label" style="width: 60px">成功:</label><label id="import_info_success" class="col-sm-1 control-label" style="width: 150px"></label>
                        </div>
                        <div class="col-sm-3">
                            <label class="col-sm-1 control-label" style="width: 60px">失败:</label><label id="import_info_fail" class="col-sm-1 control-label" style="width: 150px"></label>
                        </div>
                    </div>
                    <div class="row">
                        <table id="import_info_tb" class="table table-striped table-bordered table-hover dataTables-example dataTable">
                            <thead>
                                <tr>
                                    <th style="width: 10%;">
                                        IP
                                    </th>
                                    <th style="width: 90%;">
                                        失败信息
                                    </th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function importHostInfo(){
            var formData = new FormData();
            formData.append("csrfmiddlewaretoken",'{{ csrf_token }}')
            formData.append('files',$("#import_host_file")[0].files[0]);
            $.ajax({
                url: '/cmdb/host/import/',
                type: 'POST',
                processData: false,
                contentType: false,
                data:formData,
                beforeSend:function(){
                    //Alertwin.alert({ message:"正在进行，请稍候"});
                },
                success:function(responseStr) {
                    if(responseStr.status===0){
                        Alertwin.alert({message:"正在进行，请稍候"});
                        $("#import_host_modal").modal('hide');
                        location.reload();
                    }else{
                        Alertwin.alert({message:responseStr.msg});
                    }
                },
                error:function(responseStr) {
                    console.log(responseStr);
                }
            });
        }

        var host1_sh = null;
        function initImportModal(){
            $("#import_info_modal").on('show.bs.modal',function(event){
                getImportStatus();
                clearInterval(host1_sh);
                host1_sh = null;
                host1_sh = setInterval(getImportStatus,3000);
            });
            $("#import_info_modal").on('hide.bs.modal',function(event){
                $("#import_info_tb tbody").empty();
                clearInterval(host1_sh);
                host1_sh = null;
                window.location.reload();
            });
        }

        function getImportStatus(){
            $.ajax({
                type: "get",
                url: '../getImportInfo/',
                data:{},
                error: function (request) {},
                success: function (d) {
                    data = d.result

                    $("#import_info_total").text(data.total);
                    $("#import_info_success").text(data.success);
                    $("#import_info_fail").text(data.fail);
                    var tb = $("#import_info_tb tbody");
                    $(data.failList).each(function(i,item){
                        var htmlStr = "<tr><td>"+item.host_ip+"</td><td>"+item.error+"</td></tr>";
                        tb.append(htmlStr)
                    });
                    if(data.isImportRun == 0 || d.isRun == 0){
                        clearInterval(host1_sh);
                        host1_sh = null;
                    }
                }
            });
        }
    </script>
{% endblock %}

