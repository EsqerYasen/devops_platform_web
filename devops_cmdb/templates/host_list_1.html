{% extends 'common/basic_rank_list.html' %}
{% load widget_tweaks %}

{% block list_title %}
    未分配主机
{% endblock %}

{% block  group_count %}
    <div class="col-sm-8">
{#        {% if user.is_superuser %}#}
{#            <a href="../add/" class="btn btn-sm btn-info" style="margin-right: 10px">全部：300</a>#}
{#            <a href="../add/" class="btn btn-sm btn-info" style="margin-right: 10px">EC：100</a>#}
{#            <a href="../add/" class="btn btn-sm btn-info" style="margin-right: 10px">Brand：100</a>#}
{#            <a href="../add/" class="btn btn-sm btn-info" style="margin-right: 10px">Store：100</a>#}
{#        {% endif %}#}
    </div>
{% endblock %}

{% block  list_search %}
    <div class="col-sm-3" ></div>
    <div class="col-sm-2">
        <input type="text" name="host_ip" class="form-control" placeholder="请输入IP">
    </div>
{% endblock %}

{% block list_filter %}
    <button type="submit" class="btn btn-sm btn-primary" style="margin-right: 10px"><i class="fa fa-search"></i> 搜索</button>
    <button type="button" class="btn btn-sm btn-success" data-toggle='modal' data-target='#to_not_online_modal' style="margin-right: 10px"><i class="glyphicon glyphicon-log-in"></i> 待上线</button>
    <button type="button" class="btn btn-sm btn-success" onclick="scanBatch()" style="margin-right: 10px"><i class="glyphicon glyphicon-search"></i> 扫描</button>
{% endblock %}

{% block list_content %}
    <script type="text/javascript" src="/static/hplus/js/chosen/chosen.jquery.js"></script>
    <script type="text/javascript" src="/static/hplus/js/fileinput.min.js"></script>
    <script type="text/javascript" src="/static/hplus/js/fileinput.zh.js"></script>
    <script type="text/javascript" src="/static/hplus/js/zTree/jquery.ztree.core.js"></script>
    <script type="text/javascript" src="/static/hplus/js/zTree/jquery.ztree.excheck.js"></script>
    <script type="text/javascript" src="/static/hplus/js/zTree/jquery.ztree.exedit.js"></script>
    <link href="/static/hplus/css/chosen/chosen.css" rel="stylesheet">
    <link href="/static/hplus/css/fileinput.min.css" rel="stylesheet">
    <link href="/static/hplus/css/zTree/bootstrapStyle.css" rel="stylesheet">

    <div class="row">
        <div class="col-sm-3" style="max-height: 600px;overflow-y: auto">
            <ul id="host_group_tree" name="host_group_tree" class="ztree"></ul>
        </div>
        <div class="col-sm-9">
            <table id="tb" class="table table-striped table-bordered table-hover dataTables-example dataTable">
                <thead>
                    <tr>
                        <th style="width:3%;"><input id="checkall" type="checkbox" class="i-checks"></th>
                        <th style="width: 8%;">
                            机房
                        </th>
                        <th style="width: 8%;">
                            区域
                        </th>
                        <th style="width: 8%;">
                            IP
                        </th>
                        <th style="width: 11%;">
                            品牌
                        </th>
                        <th style="width: 6%;">
                            业务线
                        </th>
                        <th style="width:8%;">操作</th>
                    </tr>
                </thead>
                <tbody>
                {% for o in result_list %}
                    <tr>
                        <td>
                            <input type="checkbox" class="i-checks icheck" id="{{ o.id }}" hostip="{{ o.host_ip }}" name="trCheckbox">
                        </td>
                        <td>{{ o.physical_idc_name }}</td>
                        <td>{{ o.logical_idc_name }}</td>
                        <td>{{ o.host_ip }}</td>
                        <td>{{ o.biz_brand_name }}</td>
                        <td>{{ o.biz_group_name }}</td>
                        <td>
                            <a href="../{{ o.id }}/detail1/" class="btn btn-sm btn-success"><i class="fa fa-book"></i> 查看</a>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <script>
         $(document).ready(function () {
             var hostGroupTreeList = {{ hostGroup_list|safe }};
             readHostGroupTreeNext(hostGroupTreeList,0);
             zHostGroupTreeInit();
         })

         var zHostGroupNodes = [];
         function readHostGroupTreeNext(list,pid){
            $(list).each(function(i,item){
                var ids = item.id;
                var nodeData = {id:ids,pId:pid,name:item.name,nodeId:ids,open:true,hasIp:item.has_ip,'nocheck':true};

                if(item.childs){
                    readHostGroupTreeNext(item.childs,ids);
                }else{
                    nodeData['nocheck']=false;
                }
                zHostGroupNodes.push(nodeData);
            });
         }

         function zHostGroupTreeInit(){
            var setting = {
                view: {
                    selectedMulti: false,
                    addDiyDom: addDiyDom,
                },
                check: {
                    enable: true,
                    //chkboxType:  { "Y": "", "N": "" }
                },
                data: {
                    simpleData: {
                        enable: true
                    }
                },
                edit: {
                    enable: false
                },
                callback:{
                    onDblClick:zHostGroupTreeDblClick,
                }
            };
            $.fn.zTree.init($("#host_group_tree"), setting, zHostGroupNodes);
        }

        function addDiyDom(treeId, treeNode) {
             var aObj = $("#" + treeNode.tId + "_a");

             if(treeNode.hasIp == 1){
                 if($("#viewIpBtn_"+treeNode.id).length==0){
                     var viewBtn = "<span class='button ico_docu' id='viewIpBtn_" + treeNode.id+ "' title='节点下绑定的IP' onfocus='this.blur();'></span>";
                     aObj.append(viewBtn);
                     var btn = $("#viewIpBtn_"+treeNode.id);
                     if (btn){
                         btn.bind("click", function(){
                             alert("diy Button for " + treeNode.name + " "+treeNode.nodeId);
                             $("#viewIpBtn_"+treeNode.tId).unbind().remove();
                         });
                     }
                 }
             }
             if(!treeNode.nocheck){
                 if($("#bindIpToNode_"+treeNode.id).length==0){
                     var bindIpToNode = "<span class='button add' id='bindIpToNode_" + treeNode.id+ "' title='机器绑定' onfocus='this.blur();'></span>";
                     aObj.append(bindIpToNode);

                     var btn = $("#bindIpToNode_"+treeNode.id);
                     if (btn){
                         btn.bind("click", function(){
                             var ids = getChecked();
                             if (ids == "") {
                                 Alertwin.alert({ message: "请选择至少一条记录进行绑定"});
                             } else {
                                Alertwin.confirm({ message: "确定要绑定这批机器到 “"+treeNode.name+"”下吗？" }).on(function (e) {
                                    if(e){
                                        ids = ids.substring(0, ids.length - 1);
                                        alert("ids = " + ids);
                                    }
                                })

                             }
                             $("#bindIpToNode_"+treeNode.tId).unbind().remove();
                         });
                     }
                 }
                 if($("#removeIpFromNode_"+treeNode.id).length==0){
                     var removeIpFromNode = "<span class='button remove' id='removeIpFromNode_" + treeNode.id+ "' title='机器解绑' onfocus='this.blur();'></span>";
                     aObj.append(removeIpFromNode);
                     var btn = $("#removeIpFromNode_"+treeNode.id);
                     if (btn){
                         btn.bind("click", function(){
                             var ids = getChecked();
                             if (ids == "") {
                                 Alertwin.alert({ message: "请选择至少一条记录进行解绑"});
                             } else {
                                Alertwin.confirm({ message: "确定要解绑这批机器“"+treeNode.name+"”下吗？" }).on(function (e) {
                                    if(e){
                                        ids = ids.substring(0, ids.length - 1);
                                        alert("ids = " + ids);
                                    }
                                })

                             }
                             $("#removeIpFromNode_"+treeNode.tId).unbind().remove();
                         });
                     }
                 }
             }
        }

        function zHostGroupTreeDblClick(event, treeId, treeNode){
             alert(treeNode.tId + ", " + treeNode.name);
        }

        function getCheckedHostIP() {
            var str = document.getElementsByName("trCheckbox");
            var objarray = str.length;
            var chestr = "";
            for (i = 0; i < objarray; i++) {
                if (str[i].checked == true) {
                    chestr += $(str[i]).attr('hostip') + ",";
                }
            }
            return chestr;
        }

        function scanBatch(){
            var obj = getCheckedHostIP();
            if (obj == "") {
                Alertwin.alert({ message: "请选择至少一条记录进行扫描"});
            } else {
                obj = obj.substring(0, obj.length - 1);
                $.ajax({
                    type: "POST",
                    url: '../scanHost1/',
                    data:{'hostIp':obj,'csrfmiddlewaretoken':'{{ csrf_token }}'},
                    error: function (request) {
                        layer.closeAll('loading');
                    },
                    success: function (data) {
                        Alertwin.alert({ message: "扫描完成"});
                        layer.closeAll('loading');
                    }
                });
            }
        }


    </script>

{% endblock %}


